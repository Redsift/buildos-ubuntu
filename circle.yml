machine:
  environment:
    CONTAINER_NAME: quay.io/redsift/buildos-ubuntu
    CONTAINER_GO_NAME: quay.io/redsift/buildos-go-ubuntu
    CIRCLE_REVERSE_DEPENDENCIES: buildos
  services:
    - docker

general:
  branches:
    only:
      - master

checkout:
  post:
    - git fetch --tags
    - git submodule sync
    - git submodule update --init

dependencies:
  override:
    - "docker info"
    - "docker login -e $QUAY_EMAIL -u $QUAY_USER -p $QUAY_PASS quay.io"
    - |
        VERSION=$(git describe --exact-match --tags 2>/dev/null || git rev-parse --short HEAD)
        sudo docker build -t $CONTAINER_NAME .
        echo "Tagging as $CONTAINER_NAME:$VERSION"
        docker tag -f $CONTAINER_NAME:latest $CONTAINER_NAME:$VERSION
        echo "Tagging as $CONTAINER_NAME:${CIRCLE_BRANCH}"
        docker tag -f $CONTAINER_NAME:latest $CONTAINER_NAME:${CIRCLE_BRANCH}
        sudo docker build -t $CONTAINER_GO_NAME -f Dockerfile.go.ubuntu .
        echo "Tagging as $CONTAINER_GO_NAME:$VERSION"
        docker tag -f $CONTAINER_GO_NAME:latest $CONTAINER_GO_NAME:$VERSION
        echo "Tagging as $CONTAINER_GO_NAME:${CIRCLE_BRANCH}"
        docker tag -f $CONTAINER_GO_NAME:latest $CONTAINER_GO_NAME:${CIRCLE_BRANCH}

test:
  override:
    - "docker run -a stdout -a stderr --entrypoint=/usr/bin/tools-version-dump.sh $CONTAINER_NAME"
    - "docker run -a stdout -a stderr --entrypoint=/usr/bin/go-version-dump.sh $CONTAINER_GO_NAME"

deployment:
  prod:
    branch: master
    commands:
      - "docker push $CONTAINER_NAME"
      - "docker push $CONTAINER_GO_NAME"
      - "./circle_ci_trigger_build"
